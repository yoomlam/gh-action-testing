name: Create release tag

on:
  # Run manually, or hook this up to whatever trigger you want
  workflow_dispatch:
  # Example: run on pushes to main
  push:
    branches: [ main ]

jobs:
  tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # important: get all tags
          fetch-depth: 0

      - name: Generate next tag
        id: gen_tag
        shell: bash
        run: |
          # 1) Get today's date as YYYY.MM.DD
          DATE="$(date +'%Y.%m.%d')"

          # 2) Find existing tags for today's date: vYYYY.MM.DD.*
          LAST_TAG="$(git tag --list "v${DATE}.*" | sort -V | tail -n 1)"
          echo "Latest tag for $DATE: ${LAST_TAG:-<none>}"

          # 3) Determine next counter
          if [ -z "$LAST_TAG" ]; then
            i=1
          else
            # suffix after the last dot, e.g. v2025.11.24.03 -> 03
            suffix="${LAST_TAG##*.}"
            # 10# to avoid octal interpretation on leading zeroes
            i=$((10#$suffix + 1))
          fi

          # 4) Build the tag as vYYYY.MM.DD.II (II = 2 digits)
          printf -v TAG "v%s.%02d" "$DATE" "$i"
          echo "Next tag: $TAG"

          # 5) Expose as step output
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: echo release tag
        run: echo "Release tag ${{ steps.gen_tag.outputs.tag }}"

      - name: Push new tag
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/${{ steps.gen_tag.outputs.tag }}',
              sha: context.sha
            })

      - name: Push new tag
        uses: actions/github-script@v6
        with:
          script: |
            github_client.rest.repos.create_release({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: '${{ steps.gen_tag.outputs.tag }}',
              name: 'Release ${{ steps.gen_tag.outputs.tag }}',
              generate_release_notes: true
            })
          